[//]: # (Automatically generated by Sociable Weaver)
# Shopping Distributed Spring Boot Demo using Kafka Asynchronous communication

A simple distributed application that has two components, each deployed as a
separate Java application.

- Catalogue
- Cart (shopping cart)

The _Cart_ component depends on information available in the _Catalogue_
component, such as the _CatalogueItem_, _id_ and, _caption_. The components are
connected through a Kafka topic. While the _Cart_ component depends on the
_Catalogue_, the applications can run independently and only Kafka needs to
be present.

This distributed application gives up _consistency_ in favour of _availability_
and _partition tolerance_. Other tradeoffs are also valid, but not explored
here.

## Preloaded data

To keep things simple, weâ€™ll use the
[H2](https://www.h2database.com/html/main.html) in-memory database preloaded
with the following data:

- **Catalog Items**

  | `id` | `caption`     | `description`                                                         |
  | ---: | ------------- | --------------------------------------------------------------------- |
  |    1 | Leather Sofa  | A very nice and comfortable sofa                                      |
  |    2 | Wooden Table  | A large table ideal for 6 to 8 people                                 |
  |    3 | Plastic Chair | A robust plastic chair ideal for children and adults alike            |
  |    4 | Mug           | The ideal way to start the day                                        |
  |    5 | LED TV        | A very large TV set, ideal for those who love to binge-watch TV shows |

- **Carts**

  | `id` |
  | ---: |
  |    1 |
  |    2 |
  |    3 |

- **Cart Items**

  | `cart_id` | `item_id` | `quantity` |
  | --------: | --------: | ---------: |
  |         1 |         1 |          1 |
  |         1 |         5 |          1 |
  |         2 |         2 |          1 |
  |         2 |         3 |          6 |
  |         3 |         4 |          4 |

The `cart_id` and `item_id` in the cart items table are (not enforced) foreign
keys to the cart and catalogue item tables/databases, respectively.

## Prerequisites

- [Oracle Java 21](https://www.oracle.com/java/technologies/downloads/#java21)
- Container runtime, such as [Colima](https://github.com/abiosoft/colima)
- [Kafka](https://kafka.apache.org/), that can be started using docker. Kafka
  requires [Zookeeper](https://zookeeper.apache.org/) to handle leadership
  election.

## Run the example

1. **Build all application**

   This builds both projects, runs the respective tests and then copies the fat
   JAR files into the [`./.demo` directory](./.demo).

   ```shell
   rm -rf './.demo'
   ../mvnw clean package
   ```

   All tests should pass.

   (_Optional_) Verify that the fat JAR files were all created and copied.

   ```shell
   tree --charset=ascii --dirsfirst --sort=name -L 1 --prune './.demo'
   ```

   The fat JAR files from both projects

   ```
   ./.demo
   |-- demo-shopping-distributed-kafka-cart-1.0.0.jar
   `-- demo-shopping-distributed-kafka-catalogue-1.0.0.jar

   1 directory, 2 files
   ```

2. **Start Zookeeper and Kafka**

   ```shell
   # Start Zookeeper
   docker run \
     --rm \
     --detach \
     --network=host \
     --env ZOOKEEPER_CLIENT_PORT=2181 \
     --env ZOOKEEPER_TICK_TIME=2000 \
     --name 'shopping-zookeeper-demo' \
     'confluentinc/cp-zookeeper:7.7.0'

   # Start Kafka
   docker run \
     --rm \
     --detach \
     --network=host \
     --env KAFKA_BROKER_ID=1 \
     --env KAFKA_ZOOKEEPER_CONNECT='localhost:2181' \
     --env KAFKA_LISTENER_SECURITY_PROTOCOL_MAP='PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT' \
     --env KAFKA_ADVERTISED_LISTENERS='PLAINTEXT://localhost:29092,PLAINTEXT_HOST://localhost:9092' \
     --env KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
     --name 'shopping-kafka-demo' \
     'confluentinc/cp-kafka:7.7.0'
   ```

3. **Run the application**

   The _Cart_ component depends on the events triggered _Catalogue_ component
   but not on the component itself. Both the _Cart_ and the _Catalogue_
   components depend on Kafka and given that this is running, each component can
   be started independent of the other.

   The components are started in the background for convenience, and can be
   started in different terminal sessions if preferred.

   Run the _Catalogue_ component (in the background).

   ```shell
   # Start the application in the background
   java -jar './.demo/demo-shopping-distributed-kafka-catalogue-1.0.0.jar' > './.demo/output-catalogue.txt' 2>&1 &

   # Wait for the application to start
   while [ "$(curl --silent --output /dev/null --write-out '%{http_code}' 'http://localhost:8081/catalogue/item/1')" -ne '200' ]
   do
     echo 'Waiting for the Catalogue component to start'
     sleep 1
   done
   ```

   Run the _Cart_ component (in the background).

   ```shell
   # Start the application in the background
   java -jar './.demo/demo-shopping-distributed-kafka-cart-1.0.0.jar' > './.demo/output-cart.txt' 2>&1 &

   # Wait for the application to start
   while [ "$(curl --silent --output /dev/null --write-out '%{http_code}' 'http://localhost:8082/cart/1')" -ne '200' ]
   do
     echo 'Waiting for the Cart component to start'
     sleep 1
   done
   ```

   Note that both components are running on different ports.

   | Component   |   Port |
   | ----------- | -----: |
   | _Catalogue_ | `8081` |
   | _Cart_      | `8082` |

4. **Try the application**

   1. **Request a catalogue item**

      The database contains the following catalogue items, as shown in the
      following table.

      | `id` | `caption`     | `description`                                                         |
      | ---: | ------------- | --------------------------------------------------------------------- |
      |    1 | Leather Sofa  | A very nice and comfortable sofa                                      |
      |    2 | Wooden Table  | A large table ideal for 6 to 8 people                                 |
      |    3 | Plastic Chair | A robust plastic chair ideal for children and adults alike            |
      |    4 | Mug           | The ideal way to start the day                                        |
      |    5 | LED TV        | A very large TV set, ideal for those who love to binge-watch TV shows |

      ```shell
      curl --silent 'http://localhost:8081/catalogue/item/1' | jq
      ```

      The catalogue item with id `1`

      ```json
      {
        "id": 1,
        "caption": "Leather Sofa",
        "description": "A very nice and comfortable sofa"
      }
      ```

   2. **Request a cart**

      The database also contains the following carts, with their respective
      catalogue items and quantities, as shown in the following table.

      | `cart_id` | `item_id` | `caption`     | `quantity` |
      | --------: | --------: | ------------- | ---------: |
      |         1 |         1 | Leather Sofa  |          1 |
      |         1 |         5 | LED TV        |          1 |
      |         2 |         2 | Wooden Table  |          1 |
      |         2 |         3 | Plastic Chair |          6 |
      |         3 |         4 | Mug           |          4 |

      ```shell
      curl --silent 'http://localhost:8082/cart/1' | jq
      ```

      The cart item with id `1`

      ```json
      {
        "id": 1,
        "items": [
          {
            "id": 1,
            "caption": "Leather Sofa",
            "quantity": 1
          },
          {
            "id": 5,
            "caption": "LED TV",
            "quantity": 1
          }
        ]
      }
      ```

   3. **Add a new catalogue item**

      Add the following item to the catalogue

      | Property Name | Value                                   |
      | ------------- | --------------------------------------- |
      | `caption`     | Green Plant                             |
      | `description` | Put a little life in your living room!! |

      ```shell
      # Save the response in a file as we will use it later on
      curl --silent \
        -X POST 'http://localhost:8081/catalogue/item' \
        -H 'Content-Type: application/json' \
        -d '{"caption":"Green Plant","description":"Put a little life in your living room!!"}' \
        | jq \
        > './.demo/new-catalogue-item.json'

      # Print the output
      jq . './.demo/new-catalogue-item.json'
      ```

      This will return the newly added catalogue item together with its id.

      ```json
      {
        "id": 6,
        "caption": "Green Plant",
        "description": "Put a little life in your living room!!"
      }
      ```

      Print the new catalogue item id

      ```shell
      # Print the new catalogue item id
      ITEM_ID="$(jq .id './.demo/new-catalogue-item.json')"
      echo "New catalogue item id: ${ITEM_ID}"
      ```

      The newly created catalogue item id

      ```
      New catalogue item id: 6
      ```

   4. **Add the new catalogue item to cart**

      Please note that this depends on the previous step.

      Fetch the cart details.

      ```shell
      curl --silent 'http://localhost:8082/cart/3' | jq
      ```

      The current cart contents

      ```json
      {
        "id": 3,
        "items": [
          {
            "id": 4,
            "caption": "Mug",
            "quantity": 4
          }
        ]
      }
      ```

      Read the new item id obtained from the previous step and fetch the
      catalogue item.

      ```shell
      # Read the new item id obtained from the previous command
      ITEM_ID="$(jq .id './.demo/new-catalogue-item.json')"

      # Fetch the new catalogue item
      curl --silent "http://localhost:8081/catalogue/item/${ITEM_ID}" | jq
      ```

      The newly created catalogue item

      ```json
      {
        "id": 6,
        "caption": "Green Plant",
        "description": "Put a little life in your living room!!"
      }
      ```

      Add the newly created catalogue item to the cart.

      ```shell
      # Sleep a bit before proceeding allowing the Cart to consume the message and
      # populate its tables
      sleep 5

      # Read the new item id obtained from the previous command
      ITEM_ID="$(jq .id './.demo/new-catalogue-item.json')"

      # Add the new item to cart with id 3
      curl --silent -X POST "http://localhost:8082/cart/3/item/${ITEM_ID}" | jq
      ```

      The cart contents after adding the newly created catalogue item.

      ```json
      {
        "id": 3,
        "items": [
          {
            "id": 4,
            "caption": "Mug",
            "quantity": 4
          },
          {
            "id": 6,
            "caption": "Green Plant",
            "quantity": 1
          }
        ]
      }
      ```

5. **Stop the application once ready**

   The order in which the _Cart_ and the _Catalogue_ components are stopped does
   not make a difference.

   ```shell
   kill "$(jcmd | grep 'demo-shopping-distributed-kafka-cart-1.0.0.jar' | cut -d' ' -f1)"
   kill "$(jcmd | grep 'demo-shopping-distributed-kafka-catalogue-1.0.0.jar' | cut -d' ' -f1)"
   ```

6. **Stop Kafka and Zookeeper Once Ready**

   ```shell
   docker stop 'shopping-kafka-demo'
   docker stop 'shopping-zookeeper-demo'
   ```
