[//]: # (Automatically generated by Sociable Weaver)
# Shopping

A simple web application comprising from two components, a catalogue and a cart.
The cart component depends on the catalogue component for information about the
catalogue items, such as description.

This demo implements the same solution using different architecture styles:
- [Monolithic Layered](./monolithic-layered/README.md)
- [Monolithic Modular](./monolithic-modular/README.md)
- [Distributed REST (synchronous)](./distributed-rest/README.md)
- [Distributed Messaging (asynchronous)](./distributed-messaging/README.md)

Please refer to each project for more information about the specific
implementation.

All projects copy their artifacts into the `./demo` directory for convenience.

## Preloaded data

To keep things simple, we’ll use the
[H2](https://www.h2database.com/html/main.html) in-memory database preloaded
with the following data:

- **Catalog Items**

  | `id` | `caption`     | `description`                                                         |
  | ---: | ------------- | --------------------------------------------------------------------- |
  |    1 | Leather Sofa  | A very nice and comfortable sofa                                      |
  |    2 | Wooden Table  | A large table ideal for 6 to 8 people                                 |
  |    3 | Plastic Chair | A robust plastic chair ideal for children and adults alike            |
  |    4 | Mug           | The ideal way to start the day                                        |
  |    5 | LED TV        | A very large TV set, ideal for those who love to binge-watch TV shows |

- **Carts**

  | `id` |
  | ---: |
  |    1 |
  |    2 |
  |    3 |

- **Cart Items**

  | `cart_id` | `item_id` | `quantity` |
  | --------: | --------: | ---------: |
  |         1 |         1 |          1 |
  |         1 |         5 |          1 |
  |         2 |         2 |          1 |
  |         2 |         3 |          6 |
  |         3 |         4 |          4 |

The `cart_id` and `item_id` in the cart items table are foreign keys to the cart
and catalogue item tables, respectively.

## Prerequisites

- [Oracle Java 21](https://www.oracle.com/java/technologies/downloads/#java21)
- Container runtime, such as [Colima](https://github.com/abiosoft/colima)

## Run the examples

1. **Build all applications**

   This builds all projects, runs the respective tests and then copies the fat
   JAR files into the [`./demo` directory](./demo).

   ```shell
   ./mvnw clean package
   ```

   All tests should pass.

   (_Optional_) Verify that the fat JAR files were all created and copied.

   ```shell
   tree --charset=ascii --dirsfirst --sort=name -L 1 --prune './demo'
   ```

   The fat JAR files from all projects

   ```
   ./demo
   |-- demo-shopping-distributed-kafka-cart-1.0.0.jar
   |-- demo-shopping-distributed-kafka-catalogue-1.0.0.jar
   |-- demo-shopping-distributed-messaging-cart-1.0.0.jar
   |-- demo-shopping-distributed-messaging-catalogue-1.0.0.jar
   |-- demo-shopping-distributed-rest-cart-1.0.0.jar
   |-- demo-shopping-distributed-rest-catalogue-1.0.0.jar
   |-- demo-shopping-monolithic-layered-1.0.0.jar
   |-- demo-shopping-monolithic-modular-1.0.0.jar
   |-- new-catalogue-item.json
   `-- output.txt

   1 directory, 10 files
   ```

2. **Run the applications**

   There are four web applications, and these applications listens on the same
   ports, such as `8080`, `8081`, and `8082`. Change the default port to run
   these applications at the same time.

   Please refer to each section to see how to run the respective application.

   - [Run the Monolithic Layered Application](#run-the-monolithic-layered-application)
   - [Run the Monolithic Modular Application](#run-the-monolithic-modular-application)

### Run the Monolithic Layered Application

This application doesn’t have any dependencies and listens to web requests on
port `8080` unless otherwise specified.

1. **Start the application**

   ```shell
   # Start the application in the background
   java -jar './demo/demo-shopping-monolithic-layered-1.0.0.jar' > './demo/output.txt' 2>&1 &

   # Wait for the application to start
   while [ "$(curl --silent --output /dev/null --write-out '%{http_code}' 'http://localhost:8080/catalogue/item/1')" -ne '200' ]; do echo 'Waiting for the application to start'; sleep 1; done
   ```

   This starts our application in the background and waits for it to start.

2. **Request a catalogue item**

   The database contains the following catalogue items, as shown in the
   following table.

   | `id` | `caption`     | `description`                                                         |
   | ---: | ------------- | --------------------------------------------------------------------- |
   |    1 | Leather Sofa  | A very nice and comfortable sofa                                      |
   |    2 | Wooden Table  | A large table ideal for 6 to 8 people                                 |
   |    3 | Plastic Chair | A robust plastic chair ideal for children and adults alike            |
   |    4 | Mug           | The ideal way to start the day                                        |
   |    5 | LED TV        | A very large TV set, ideal for those who love to binge-watch TV shows |

   ```shell
   curl --silent 'http://localhost:8080/catalogue/item/1' | jq
   ```

   The catalogue item with id `1`

   ```json
   {
     "id": 1,
     "caption": "Leather Sofa",
     "description": "A very nice and comfortable sofa"
   }
   ```

3. **Request a cart**

   The database also contains the following carts, with their respective
   catalogue items and quantities, as shown in the following table.

   | `cart_id` | `item_id` | `caption`     | `quantity` |
   | --------: | --------: | ------------- | ---------: |
   |         1 |         1 | Leather Sofa  |          1 |
   |         1 |         5 | LED TV        |          1 |
   |         2 |         2 | Wooden Table  |          1 |
   |         2 |         3 | Plastic Chair |          6 |
   |         3 |         4 | Mug           |          4 |

   ```shell
   curl --silent 'http://localhost:8080/cart/1' | jq
   ```

   The cart item with id `1`

   ```json
   {
     "id": 1,
     "items": [
       {
         "id": 1,
         "caption": "Leather Sofa",
         "quantity": 1
       },
       {
         "id": 5,
         "caption": "LED TV",
         "quantity": 1
       }
     ]
   }
   ```

4. **Add a new catalogue item**

   Add the following item to the catalogue

   | Property Name | Value                                   |
   | ------------- | --------------------------------------- |
   | `caption`     | Green Plant                             |
   | `description` | Put a little life in your living room!! |

   ```shell
   # Save the response in a file as we will use it later on
   curl --silent \
     -X POST 'http://localhost:8080/catalogue/item' \
     -H 'Content-Type: application/json' \
     -d '{"caption":"Green Plant","description":"Put a little life in your living room!!"}' \
     | jq \
     > './demo/new-catalogue-item.json'

   # Print the output
   jq . './demo/new-catalogue-item.json'
   ```

   This will return the newly added catalogue item together with its id.

   ```json
   {
     "id": 6,
     "caption": "Green Plant",
     "description": "Put a little life in your living room!!"
   }
   ```

   Print the new catalogue item id

   ```shell
   # Print the new catalogue item id
   ITEM_ID="$(jq .id './demo/new-catalogue-item.json')"
   echo "New catalogue item id: ${ITEM_ID}"
   ```

   The newly created catalogue item id

   ```
   New catalogue item id: 6
   ```

5. **Add the new catalogue item to cart**

   Please note that this depends on the previous step.

   Fetch the cart details.

   ```shell
   curl --silent 'http://localhost:8080/cart/3' | jq
   ```

   The current cart contents

   ```json
   {
     "id": 3,
     "items": [
       {
         "id": 4,
         "caption": "Mug",
         "quantity": 4
       }
     ]
   }
   ```

   Read the new item id obtained from the previous step and fetch the catalogue
   item.

   ```shell
   # Read the new item id obtained from the previous command
   ITEM_ID="$(jq .id './demo/new-catalogue-item.json')"

   # Fetch the new catalogue item
   curl --silent "http://localhost:8080/catalogue/item/${ITEM_ID}" | jq
   ```

   The newly created catalogue item

   ```json
   {
     "id": 6,
     "caption": "Green Plant",
     "description": "Put a little life in your living room!!"
   }
   ```

   Add the newly created catalogue item to the cart.

   ```shell
   # Read the new item id obtained from the previous command
   ITEM_ID="$(jq .id './demo/new-catalogue-item.json')"

   # Add the new item to cart with id 3
   curl --silent -X POST "http://localhost:8080/cart/3/item/${ITEM_ID}" | jq
   ```

   The cart contents after adding the newly created catalogue item.

   ```json
   {
     "id": 3,
     "items": [
       {
         "id": 4,
         "caption": "Mug",
         "quantity": 4
       },
       {
         "id": 6,
         "caption": "Green Plant",
         "quantity": 1
       }
     ]
   }
   ```

6. **Stop the application once ready**

   ```shell
   kill "$(jcmd | grep 'demo-shopping-monolithic-layered-1.0.0.jar' | cut -d' ' -f1)"
   ```

### Run the Monolithic Modular Application

This application doesn’t have any dependencies and listens to web requests on
port `8080` unless otherwise specified.

1. **Start the application**

   ```shell
   # Start the application in the background
   java -jar './demo/demo-shopping-monolithic-modular-1.0.0.jar' > './demo/output.txt' 2>&1 &

   # Wait for the application to start
   while [ "$(curl --silent --output /dev/null --write-out '%{http_code}' 'http://localhost:8080/catalogue/item/1')" -ne '200' ]; do echo 'Waiting for the application to start'; sleep 1; done
   ```

   This starts our application in the background and waits for it to start.

2. **Request a catalogue item**

   The database contains the following catalogue items, as shown in the
   following table.

   | `id` | `caption`     | `description`                                                         |
   | ---: | ------------- | --------------------------------------------------------------------- |
   |    1 | Leather Sofa  | A very nice and comfortable sofa                                      |
   |    2 | Wooden Table  | A large table ideal for 6 to 8 people                                 |
   |    3 | Plastic Chair | A robust plastic chair ideal for children and adults alike            |
   |    4 | Mug           | The ideal way to start the day                                        |
   |    5 | LED TV        | A very large TV set, ideal for those who love to binge-watch TV shows |

   ```shell
   curl --silent 'http://localhost:8080/catalogue/item/1' | jq
   ```

   The catalogue item with id `1`

   ```json
   {
     "id": 1,
     "caption": "Leather Sofa",
     "description": "A very nice and comfortable sofa"
   }
   ```

3. **Request a cart**

   The database also contains the following carts, with their respective
   catalogue items and quantities, as shown in the following table.

   | `cart_id` | `item_id` | `caption`     | `quantity` |
   | --------: | --------: | ------------- | ---------: |
   |         1 |         1 | Leather Sofa  |          1 |
   |         1 |         5 | LED TV        |          1 |
   |         2 |         2 | Wooden Table  |          1 |
   |         2 |         3 | Plastic Chair |          6 |
   |         3 |         4 | Mug           |          4 |

   ```shell
   curl --silent 'http://localhost:8080/cart/1' | jq
   ```

   The cart item with id `1`

   ```json
   {
     "id": 1,
     "items": [
       {
         "id": 1,
         "caption": "Leather Sofa",
         "quantity": 1
       },
       {
         "id": 5,
         "caption": "LED TV",
         "quantity": 1
       }
     ]
   }
   ```

4. **Add a new catalogue item**

   Add the following item to the catalogue

   | Property Name | Value                                   |
   | ------------- | --------------------------------------- |
   | `caption`     | Green Plant                             |
   | `description` | Put a little life in your living room!! |

   ```shell
   # Save the response in a file as we will use it later on
   curl --silent \
     -X POST 'http://localhost:8080/catalogue/item' \
     -H 'Content-Type: application/json' \
     -d '{"caption":"Green Plant","description":"Put a little life in your living room!!"}' \
     | jq \
     > './demo/new-catalogue-item.json'

   # Print the output
   jq . './demo/new-catalogue-item.json'
   ```

   This will return the newly added catalogue item together with its id.

   ```json
   {
     "id": 6,
     "caption": "Green Plant",
     "description": "Put a little life in your living room!!"
   }
   ```

   Print the new catalogue item id

   ```shell
   # Print the new catalogue item id
   ITEM_ID="$(jq .id './demo/new-catalogue-item.json')"
   echo "New catalogue item id: ${ITEM_ID}"
   ```

   The newly created catalogue item id

   ```
   New catalogue item id: 6
   ```

5. **Add the new catalogue item to cart**

   Please note that this depends on the previous step.

   Fetch the cart details.

   ```shell
   curl --silent 'http://localhost:8080/cart/3' | jq
   ```

   The current cart contents

   ```json
   {
     "id": 3,
     "items": [
       {
         "id": 4,
         "caption": "Mug",
         "quantity": 4
       }
     ]
   }
   ```

   Read the new item id obtained from the previous step and fetch the catalogue
   item.

   ```shell
   # Read the new item id obtained from the previous command
   ITEM_ID="$(jq .id './demo/new-catalogue-item.json')"

   # Fetch the new catalogue item
   curl --silent "http://localhost:8080/catalogue/item/${ITEM_ID}" | jq
   ```

   The newly created catalogue item

   ```json
   {
     "id": 6,
     "caption": "Green Plant",
     "description": "Put a little life in your living room!!"
   }
   ```

   Add the newly created catalogue item to the cart.

   ```shell
   # Read the new item id obtained from the previous command
   ITEM_ID="$(jq .id './demo/new-catalogue-item.json')"

   # Add the new item to cart with id 3
   curl --silent -X POST "http://localhost:8080/cart/3/item/${ITEM_ID}" | jq
   ```

   The cart contents after adding the newly created catalogue item.

   ```json
   {
     "id": 3,
     "items": [
       {
         "id": 4,
         "caption": "Mug",
         "quantity": 4
       },
       {
         "id": 6,
         "caption": "Green Plant",
         "quantity": 1
       }
     ]
   }
   ```

6. **Stop the application once ready**

   ```shell
   kill "$(jcmd | grep 'demo-shopping-monolithic-modular-1.0.0.jar' | cut -d' ' -f1)"
   ```
